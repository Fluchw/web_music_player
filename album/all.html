<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多视图滚轮切换演示 (综合修复V3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Long+Cang&display=swap" rel="stylesheet">
    <style>
        /* --- 全局样式 --- */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; 
            margin: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #1a1a2e; 
        }

        /* --- 进入页面样式 --- */
        #entryPage {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000; 
            opacity: 1;
            visibility: visible;
            transition: opacity 0.8s ease-out, visibility 0s linear 0s;
        }
        #entryPage.hidden {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.8s ease-out, visibility 0s linear 0.8s;
            pointer-events: none; 
        }
        #entryPage h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        #entryPage p {
            font-size: 1.2rem;
            margin-bottom: 0; 
        }
        #entryPage .scroll-prompt { 
            margin-top: 2.5rem;
            font-size: 1rem;
            opacity: 0.7;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* --- 主内容容器 --- */
        #mainContentContainer {
            width: 100%;
            height: 100%; 
            position: relative; 
            opacity: 0; 
            visibility: hidden;
        }
        #mainContentContainer.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.5s ease-in-out 0.5s; 
        }

        .view-section { 
            width: 100%;
            height: 100%; 
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute; 
            top: 0;
            left: 0;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0s linear 0.5s;
            box-sizing: border-box;
            overflow: hidden; 
        }
        .view-section.active-view {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.5s ease-in-out, visibility 0s linear 0s;
            z-index: 10; 
        }
        
        #carouselSection { /* background-color: rgba(0,0,0,0.1); */ }
        #accordionSection { background-color: #e0e7ff; } 
        #drawerCarouselSection { /* background-color: rgba(44, 62, 80, 0.85); */ } /* 背景透明，由父级body控制 */
        #parallaxSection { overflow-y: auto; overflow-x: hidden; height: 100%;} 


        /* --- 3D 旋转木马样式 --- */
        #carouselSection .shell {
            position: relative;
            width: 85vw; 
            height: 55vw; 
            max-width: 700px; 
            max-height: 450px; 
            margin: 0;
            color: white;
            perspective: 1000px;
            transform-origin: center;
        }
        #carouselSection .content {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            width: 100%;
            height: 100%;
            transform-origin: center;
            transform-style: preserve-3d;
            transition: transform 0.7s cubic-bezier(0.165, 0.84, 0.44, 1); 
        }
        #carouselSection .item {
            position: absolute;
            width: 100%;
            height: 100%;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            background-size: cover;
            background-position: center;
            -webkit-box-reflect: below 25px -webkit-linear-gradient(transparent 50%, rgba(255, 255, 255, 0.3));
        }

        /* --- 新版水平手风琴样式 (卡片式) --- */
        .accordion-container-new { 
            display: flex;
            justify-content: center; 
            align-items: center; 
            width: 95vw; 
            max-width: 1200px; 
            height: 60vh; 
            gap: 10px; 
        }
        .accordion-panel-new {
            position: relative;
            width: 100px; 
            height: 100%; 
            border-radius: 12px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: width 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .accordion-panel-new.active { width: 400px; }
        .accordion-panel-new::before { 
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.3); transition: background-color 0.3s ease;
        }
        .accordion-panel-new:hover::before, .accordion-panel-new.active::before { background-color: rgba(0,0,0,0.1); }
        .panel-title-new {
            position: absolute; bottom: 15px; left: 15px; right: 15px; color: white;
            font-size: 1.1rem; font-weight: bold; text-shadow: 0 1px 3px rgba(0,0,0,0.6);
            padding: 10px; background-color: rgba(0,0,0,0.3); border-radius: 0 0 8px 8px; 
            text-align: center; opacity: 0; transform: translateY(20px);
            transition: opacity 0.4s ease 0.1s, transform 0.4s ease 0.1s;
        }
        .accordion-panel-new.active .panel-title-new { opacity: 1; transform: translateY(0); }

        @media (max-width: 768px) {
            #carouselSection .shell { width: 90vw; height: 60vw; max-width: 420px; max-height: 280px; }
            .accordion-container-new { height: 50vh; gap: 5px; }
            .accordion-panel-new { width: 60px; }
            .accordion-panel-new.active { width: 250px; }
            .panel-title-new { font-size: 0.9rem; padding: 8px; }
        }

        /* --- 抽屉式轮播图样式 --- */
        #drawerCarouselSection .drawer-layout-container { 
            display: flex;
            width: 100%; /* 填满 #drawerCarouselSection */
            height: 100%;/* 填满 #drawerCarouselSection */
            background-color: transparent; /* 背景透明 */
            overflow: hidden; 
            /* 移除 border-radius 和 box-shadow，使其不表现为一个卡片 */
        }
        .drawer-nav-list {
            width: 280px; padding: 0; overflow-y: auto; background-color: rgba(0, 0, 0, 0.25); 
            flex-shrink: 0; box-sizing: border-box; display: flex; flex-direction: column; 
            justify-content: space-around; 
        }
        .drawer-nav-item {
            display: flex; align-items: center; height: 70px; padding: 0 20px; 
            border-radius: 0 8px 8px 0; cursor: pointer; 
            transition: background-color 0.4s ease, width 0.4s ease, padding-left 0.4s ease;
            color: #e0e0e0; position: relative; overflow: hidden; width: 80px; 
        }
        .drawer-nav-item:hover { background-color: rgba(255, 255, 255, 0.1); }
        .drawer-nav-item.active-drawer-nav {
            background-color: rgba(255, 255, 255, 0.2); color: #fff; font-weight: bold;
            width: 100%; padding-left: 20px; 
        }
        .drawer-nav-number {
            font-size: 2.5rem; font-weight: bold; min-width: 60px; text-align: center;
            color: #bbb; transition: color 0.3s ease, opacity 0.4s ease; z-index: 2; 
        }
        .drawer-nav-item.active-drawer-nav .drawer-nav-number { color: #fff; opacity: 0.5; }
        .drawer-nav-title {
            font-size: 1rem; white-space: nowrap; opacity: 0; 
            transition: opacity 0.4s ease 0.1s; position: absolute; left: 80px; 
            top: 50%; transform: translateY(-50%); padding-right: 15px; 
        }
        .drawer-nav-item.active-drawer-nav .drawer-nav-title { opacity: 1; }
        .drawer-content-area {
            flex-grow: 1; padding: 40px; overflow-y: auto; position: relative; 
            color: #fff; box-sizing: border-box; /* background-color: rgba(0,0,0,0.1); -- 可选，如果希望内容区有轻微背景 */
        }
        .drawer-content-item {
            position: absolute; top: 40px; left: 40px; right: 40px; bottom: 40px;
            opacity: 0; visibility: hidden; transition: opacity 0.5s ease-in-out, visibility 0s linear 0.5s;
            overflow-y: auto; 
        }
        .drawer-content-item.active-drawer-content { opacity: 1; visibility: visible; transition: opacity 0.5s ease-in-out, visibility 0s linear 0s; }
        .drawer-content-item h2 { font-size: 2.2rem; color: #fff; margin-top: 0; margin-bottom: 20px; text-shadow: 0 1px 4px rgba(0,0,0,0.7); }
        .drawer-content-item .quote { font-size: 1rem; color: #e0e0e0; line-height: 1.8; margin-bottom: 30px; font-style: italic; border-left: 3px solid rgba(255,255,255,0.5); padding-left: 20px; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        .drawer-content-item img { width: 100%; max-width: 100%; height: auto; border-radius: 8px; margin-top: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .drawer-content-item p:not(.quote) { font-size: 1rem; line-height: 1.7; color: #f0f0f0; text-shadow: 0 1px 2px rgba(0,0,0,0.4); }

        /* --- 视差滚动区块样式 --- */
        #parallaxSection { 
            /* overflow-y: auto;  -- 确保这个在.view-section中被正确应用 */
        }
        .parallax-item-container { width: 100%; }
        .section-item { 
            width: 100vw; height: 45vh; position: relative; display: flex; overflow: hidden; 
        }
        .section-item__block {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: 120%; background-repeat: no-repeat; background-position: center 0; 
            transform: translate3d(0, 0, 0); will-change: background-position; 
        }
        .section-item__block::before {
            position: absolute; top: 0; left: 0; content: ''; display: block;
            width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.35); 
            transition: background-color 0.3s ease;
        }
        .section-item:hover .section-item__block::before { background-color: rgba(0, 0, 0, 0.2); }
        .section-item__text {
            position: relative; width: 100%; height: 100%; display: flex;
            align-items: center; justify-content: center; flex-direction: column;
            font-family: 'Long Cang', cursive; color: #F1F1F1; text-align: center;
            padding: 20px; box-sizing: border-box;
        }
        .section-item__text .text-title { font-size: 2.5rem; font-weight: bolder; margin-bottom: 20px; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .section-item__text .text-desc { font-size: 1.5rem; max-width: 80%; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }

        /* --- 音乐播放器样式 --- */
        #musicPlayerContainer {
            position: fixed; bottom: 20px; right: 20px; background-color: rgba(0, 0, 0, 0.75); 
            padding: 12px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            z-index: 900; display: flex; flex-direction: column; align-items: center; 
            opacity: 0; visibility: hidden; transition: opacity 0.5s ease-in-out, visibility 0s linear 0.5s;
            cursor: grab; width: 300px; 
        }
        #musicPlayerContainer.visible { opacity: 1; visibility: visible; }
        .song-info { width: 100%; text-align: center; margin-bottom: 8px; }
        #musicPlayerContainer .song-title {
            color: white; font-size: 0.9rem; font-weight: 500; display: block; 
            max-width: 260px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            margin-bottom: 4px; 
        }
        .time-display { color: #ccc; font-size: 0.75rem; }
        .player-controls { display: flex; align-items: center; justify-content: center; width: 100%; margin-top: 5px; }
        #musicPlayerContainer button {
            background: none; border: none; color: white; font-size: 1.3rem; 
            cursor: pointer; padding: 8px 12px; outline: none; line-height: 1;
        }
        #musicPlayerContainer button:hover { color: #e74c3c; }
        #musicPlayerContainer .progress-bar-container {
            width: calc(100% - 20px); height: 6px; background-color: rgba(255,255,255,0.25);
            border-radius: 3px; margin: 8px 10px; cursor: pointer;
        }
        #musicPlayerContainer .progress-bar { width: 0%; height: 100%; background-color: #e74c3c; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="entryPage">
        <h1>探索新视界</h1>
        <p>向下滑动以进入</p> 
        <div class="scroll-prompt"> <i class="fas fa-chevron-down"></i></div>
    </div>

    <div id="mainContentContainer">
        <div id="carouselSection" class="view-section">
            <div class="shell">
                <div class="content" id="carouselContent"></div>
            </div>
        </div>

        <div id="accordionSection" class="view-section">
            <div class="accordion-container-new" id="accordionContainerNew"></div>
        </div>

        <div id="drawerCarouselSection" class="view-section">
            <div class="drawer-layout-container">
                <div class="drawer-nav-list" id="drawerNavList"></div>
                <div class="drawer-content-area" id="drawerContentArea"></div>
            </div>
        </div>

        <div id="parallaxSection" class="view-section">
            <div class="parallax-item-container" id="parallaxItemContainer"></div>
        </div>
    </div>

    <div id="musicPlayerContainer">
        <audio id="backgroundMusic" loop></audio>
        <div class="song-info">
            <span class="song-title" id="songTitle">歌曲名称</span>
            <div class="time-display">
                <span id="currentTimeDisplay">0:00</span> / <span id="totalDurationDisplay">0:00</span>
            </div>
        </div>
        <div class="progress-bar-container" id="progressBarContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="player-controls">
            <button id="prevSongButton"><i class="fas fa-backward-step"></i></button>
            <button id="playPauseButton"><i class="fas fa-play"></i></button>
            <button id="nextSongButton"><i class="fas fa-forward-step"></i></button>
        </div>
    </div>

    <script>
        // --- CarouselModule ---
        const CarouselModule = (function() {
            let config = {};
            let switchToNextViewCallback = null;

            function setup() {
                if (!config.contentElement || !config.shellElement) { return; }
                if (config.itemImageUrls.length === 0) {
                    config.contentElement.innerHTML = '<p style="color:white; text-align:center;">没有配置旋转木马图片</p>';
                    return;
                }
                config.angleIncrement = 360 / config.itemImageUrls.length;
                config.items = []; 
                config.contentElement.innerHTML = ''; 
                config.itemImageUrls.forEach((url, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('item'); 
                    itemElement.style.backgroundImage = `url(${url})`;
                    const rotateYValue = index * config.angleIncrement;
                    itemElement.style.transform = `rotateY(${rotateYValue}deg) translateZ(${config.translateZValue})`;
                    config.contentElement.appendChild(itemElement);
                    config.items.push(itemElement);
                });
                updateTransform(); 
            }
            function updateTransform() {
                if (!config.contentElement) return;
                const rotationY = -config.currentIndex * config.angleIncrement;
                config.contentElement.style.transform = `translateZ(-${config.translateZValue}) rotateY(${rotationY}deg)`;
            }
            function handleWheel(event) {
                let nextIndex = config.currentIndex;
                // console.log(`Carousel: currentIndex=${config.currentIndex}, total=${config.itemImageUrls.length}, deltaY=${event.deltaY}`);
                if (event.deltaY > 0) { 
                    if (config.currentIndex < config.itemImageUrls.length - 1) {
                        nextIndex++;
                    } else {
                        if (typeof switchToNextViewCallback === 'function') switchToNextViewCallback(); 
                        return true; 
                    }
                } else if (event.deltaY < 0) { 
                    if (config.currentIndex > 0) { 
                        nextIndex--;
                    } else {
                        return true; 
                    }
                }
                if (nextIndex !== config.currentIndex) {
                    config.currentIndex = nextIndex;
                    updateTransform();
                }
                return true; 
            }
            return {
                init: function(initialConfig, callbackToNext) { 
                    config = { itemImageUrls: [], translateZValue: '35vw', contentElement: null, shellElement: null, items: [], currentIndex: 0, angleIncrement: 0, ...initialConfig };
                    switchToNextViewCallback = callbackToNext; 
                    setup();
                },
                handleWheel: handleWheel,
                getConfig: function() { return config; } 
            };
        })();

        // --- AccordionModule (新版卡片式) ---
        const AccordionModule = (function() {
            let config = {};
            let switchToNextViewCallback = null;
            let switchToPrevViewCallback = null;
            
            function setActivePanel(index) {
                if (index < 0 || index >= config.panels.length || !config.panels[index]) return;
                config.panels.forEach(p => p.classList.remove('active'));
                config.panels[index].classList.add('active');
                config.currentActiveIndex = index;
            }

            function setup() {
                if (!config.containerElement) { return; }
                config.panels = []; 
                config.containerElement.innerHTML = ''; 
                config.data.forEach((dataItem, index) => {
                    const panel = document.createElement('div');
                    panel.classList.add('accordion-panel-new'); 
                    panel.style.backgroundImage = `url('${dataItem.imageUrl}')`;
                    const titleElement = document.createElement('div');
                    titleElement.classList.add('panel-title-new'); 
                    titleElement.textContent = dataItem.title;
                    panel.appendChild(titleElement);
                    config.containerElement.appendChild(panel);
                    config.panels.push(panel);
                    panel.addEventListener('click', () => { 
                        setActivePanel(index); 
                    });
                });
                if (config.panels.length > 0) setActivePanel(config.currentActiveIndex || 0); 
            }

            function handleWheel(event) {
                let nextIndex = config.currentActiveIndex;
                if (event.deltaY > 0) { 
                    if (config.currentActiveIndex < config.data.length - 1) {
                        nextIndex++;
                    } else {
                        if (typeof switchToNextViewCallback === 'function') switchToNextViewCallback(); 
                        return true; 
                    }
                } else if (event.deltaY < 0) { 
                    if (config.currentActiveIndex > 0) {
                        nextIndex--;
                    } else {
                        if (typeof switchToPrevViewCallback === 'function') switchToPrevViewCallback(); 
                        return true; 
                    }
                }
                if (nextIndex !== config.currentActiveIndex) {
                    setActivePanel(nextIndex);
                }
                return true; 
            }
            return {
                init: function(initialConfig, callbackToNext, callbackToPrev) { 
                     config = { data: [], containerElement: null, panels: [], currentActiveIndex: 0, ...initialConfig };
                    switchToNextViewCallback = callbackToNext;
                    switchToPrevViewCallback = callbackToPrev;
                    setup();
                },
                handleWheel: handleWheel,
                getConfig: function() { return config; } 
            };
        })();

        // --- DrawerCarouselModule ---
        const DrawerCarouselModule = (function() {
            let config = {};
            let switchToPrevViewCallback = null;
            let navItems = [];
            let contentItems = [];
            function setActiveDrawerItem(index) {
                if (index < 0 || index >= config.data.length) return;
                navItems.forEach(item => item.classList.remove('active-drawer-nav'));
                if (navItems[index]) navItems[index].classList.add('active-drawer-nav');
                contentItems.forEach(item => item.classList.remove('active-drawer-content'));
                if (contentItems[index]) contentItems[index].classList.add('active-drawer-content');
                config.currentIndex = index;
            }
            function setup() {
                if (!config.navContainerElement || !config.contentAreaElement) { return; }
                navItems = []; contentItems = [];
                config.navContainerElement.innerHTML = ''; config.contentAreaElement.innerHTML = '';
                config.data.forEach((dataItem, index) => {
                    const navItem = document.createElement('div');
                    navItem.classList.add('drawer-nav-item');
                    navItem.innerHTML = `<span class="drawer-nav-number">${index + 1}</span><span class="drawer-nav-title">${dataItem.navTitle || dataItem.title}</span>`;
                    navItem.addEventListener('click', () => setActiveDrawerItem(index));
                    config.navContainerElement.appendChild(navItem);
                    navItems.push(navItem);
                    const contentItem = document.createElement('div');
                    contentItem.classList.add('drawer-content-item');
                    contentItem.innerHTML = `<h2>${dataItem.title}</h2>${dataItem.quote ? `<p class="quote">${dataItem.quote}</p>` : ''}${dataItem.imageUrl ? `<img src="${dataItem.imageUrl}" alt="${dataItem.title}">` : ''}${dataItem.description ? `<p>${dataItem.description}</p>` : ''}`;
                    config.contentAreaElement.appendChild(contentItem);
                    contentItems.push(contentItem);
                });
                if (config.data.length > 0) setActiveDrawerItem(config.currentIndex || 0);
            }
            function handleWheel(event) {
                let nextIndex = config.currentIndex;
                if (event.deltaY > 0) { 
                    if (config.currentIndex < config.data.length - 1) nextIndex++;
                     else { 
                        if (typeof config.switchToNextViewCallback === 'function') config.switchToNextViewCallback();
                        return true;
                    }
                } else if (event.deltaY < 0) { 
                    if (config.currentIndex > 0) {
                        nextIndex--;
                    } else {
                        if (typeof switchToPrevViewCallback === 'function') switchToPrevViewCallback();
                        return true;
                    }
                }
                if (nextIndex !== config.currentIndex) setActiveDrawerItem(nextIndex);
                return true;
            }
            return {
                init: function(initialConfig, callbackToPrev, callbackToNext) { 
                    config = { data: [], navContainerElement: null, contentAreaElement: null, currentIndex: 0, ...initialConfig };
                    switchToPrevViewCallback = callbackToPrev;
                    config.switchToNextViewCallback = callbackToNext; 
                    setup();
                },
                handleWheel: handleWheel,
                getConfig: function() { return config; }
            };
        })();

        // --- ParallaxModule ---
        const ParallaxModule = (function() {
            let config = {};
            let switchToPrevViewCallback = null;
            let switchToNextViewCallback = null; 
            let parallaxBlocks = [];
            let parallaxContainer = null; 
            let parallaxScrollListener = null; 

            function setup() {
                parallaxContainer = config.containerElement; 
                if (!parallaxContainer || !config.itemContainerElement) {
                    console.error('视差容器或项目容器元素未找到!');
                    return;
                }
                config.itemContainerElement.innerHTML = ''; 
                parallaxBlocks = [];

                config.itemsData.forEach(data => {
                    const sectionItem = document.createElement('section');
                    sectionItem.classList.add('section-item');
                    const block = document.createElement('div');
                    block.classList.add('section-item__block');
                    block.style.backgroundImage = `url(${data.imageUrl})`;
                    const textDiv = document.createElement('div');
                    textDiv.classList.add('section-item__text');
                    textDiv.innerHTML = `<div class="text-title">${data.title}</div><div class="text-desc">${data.desc}</div>`;
                    sectionItem.appendChild(block);
                    sectionItem.appendChild(textDiv);
                    config.itemContainerElement.appendChild(sectionItem);
                    parallaxBlocks.push(block);
                });

                if (parallaxScrollListener && parallaxContainer) {
                    parallaxContainer.removeEventListener('scroll', parallaxScrollListener);
                }
                parallaxScrollListener = handleParallaxEffectScroll; 
                if (parallaxContainer) {
                    parallaxContainer.addEventListener('scroll', parallaxScrollListener);
                }
            }

            function handleParallaxEffectScroll() { 
                if (!parallaxContainer || parallaxBlocks.length === 0) return;
                const scrollTop = parallaxContainer.scrollTop; 
                const containerHeight = parallaxContainer.clientHeight;

                parallaxBlocks.forEach(el => {
                    const parentSectionItem = el.parentElement;
                    const itemRect = parentSectionItem.getBoundingClientRect();
                    const containerRect = parallaxContainer.getBoundingClientRect();
                    const itemTopRelativeToContainer = itemRect.top - containerRect.top;

                    if (itemRect.bottom > containerRect.top && itemRect.top < containerRect.bottom) {
                        const elementMidPointInContainer = itemTopRelativeToContainer + parentSectionItem.offsetHeight / 2;
                        const containerMidPoint = containerHeight / 2;
                        const difference = elementMidPointInContainer - containerMidPoint;
                        const parallaxFactor = 0.2; 
                        const yOffset = -difference * parallaxFactor;
                        el.style.backgroundPosition = `center ${yOffset}px`;
                    }
                });
            }
            
            function handleWheel(event) { 
                 if (!parallaxContainer) return false; 
                const isAtTop = parallaxContainer.scrollTop === 0;
                const isAtBottom = parallaxContainer.scrollTop + parallaxContainer.clientHeight >= parallaxContainer.scrollHeight - 5; 
                
                if (event.deltaY < 0 && isAtTop) { 
                    if (typeof switchToPrevViewCallback === 'function') {
                        switchToPrevViewCallback();
                        return true; 
                    }
                } else if (event.deltaY > 0 && isAtBottom) { 
                     // 修复BUG：当在视差滚动底部并向下滚动时，不应该调用switchToNextViewCallback
                     // 而是应该返回 false，让全局处理器知道不要阻止默认行为（如果适用）或节流
                     // 视图循环的逻辑现在完全由 Main Logic 中的 switchToView 和模块回调控制
                     return false; // 表示模块内部没有处理视图切换
                }
                return false; 
            }

            return {
                init: function(initialConfig, callbackToPrev, callbackToNext) {
                    config = {
                        itemsData: [],
                        containerElement: null, 
                        itemContainerElement: null, 
                        ...initialConfig
                    };
                    switchToPrevViewCallback = callbackToPrev;
                    switchToNextViewCallback = callbackToNext; 
                    setup();
                },
                handleWheel: handleWheel, 
                getContainerElement: function() { return parallaxContainer; } 
            };
        })();


        // --- Main Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const unifiedGlobalBackgroundImageUrl = 'https://placehold.co/1920x1080/5D5C61/ffffff?text=统一背景图'; 
            let currentView = 'carousel'; 
            const bodyElement = document.body;
            let globalIsThrottled = false;
            const globalThrottleDelay = 350; 

            const entryPage = document.getElementById('entryPage');
            const mainContentContainer = document.getElementById('mainContentContainer');
            
            const musicPlayerContainer = document.getElementById('musicPlayerContainer');
            const backgroundMusic = document.getElementById('backgroundMusic');
            const playPauseButton = document.getElementById('playPauseButton');
            const songTitleElement = document.getElementById('songTitle');
            const progressBarContainer = document.getElementById('progressBarContainer');
            const progressBar = document.getElementById('progressBar');
            const nextSongButton = document.getElementById('nextSongButton');
            const prevSongButton = document.getElementById('prevSongButton'); 
            const currentTimeDisplay = document.getElementById('currentTimeDisplay');
            const totalDurationDisplay = document.getElementById('totalDurationDisplay');


            const carouselSection = document.getElementById('carouselSection');
            const accordionSection = document.getElementById('accordionSection');
            const drawerCarouselSection = document.getElementById('drawerCarouselSection'); 
            const parallaxSection = document.getElementById('parallaxSection'); 

            if (unifiedGlobalBackgroundImageUrl) {
                bodyElement.style.backgroundImage = `url('${unifiedGlobalBackgroundImageUrl}')`;
            } else {
                console.warn("Unified background image URL is not set. Using fallback color from CSS.");
            }

            const localMusicFiles = [
                { title: "歌曲一示例", src: "music/song1.mp3" }, 
                { title: "歌曲二演示", src: "music/song2.ogg" },
                { title: "SoundHelix Song 1", src: "music/SoundHelix-Song-1.mp3" } 
            ];
            let currentSongIndex = 0;

            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
            }

            function loadSong(songIndex) {
                if (songIndex >= 0 && songIndex < localMusicFiles.length) {
                    const song = localMusicFiles[songIndex];
                    backgroundMusic.src = song.src;
                    songTitleElement.textContent = song.title;
                    backgroundMusic.load(); 
                }
            }
            
            function playCurrentSong() {
                backgroundMusic.play().catch(error => {
                    console.warn("音乐播放失败:", error);
                    if(playPauseButton) playPauseButton.innerHTML = '<i class="fas fa-play"></i>';
                });
            }


            const carouselInitialConfig = {
                itemImageUrls: ['https://placehold.co/700x450/e74c3c/ffffff?text=作品一', 'https://placehold.co/700x450/3498db/ffffff?text=作品二', 'https://placehold.co/700x450/2ecc71/ffffff?text=作品三'],
                translateZValue: '35vw', 
                contentElement: document.getElementById('carouselContent'),
                shellElement: document.querySelector('#carouselSection .shell'),
                currentIndex: 0
            };
            const accordionInitialConfig = { 
                data: [ 
                    { title: "Image", imageUrl: "https://placehold.co/1000x600/a2d2ff/333333?text=Image" }, 
                    { title: "Video", imageUrl: "https://placehold.co/1000x600/bde0fe/333333?text=Video" }, 
                    { title: "Music", imageUrl: "https://placehold.co/1000x600/ffafcc/333333?text=Music" },
                    { title: "Lyric", imageUrl: "https://placehold.co/1000x600/ffc8dd/333333?text=Lyric" } 
                ],
                containerElement: document.getElementById('accordionContainerNew'), 
                currentActiveIndex: 0,
            };
            const drawerCarouselInitialConfig = { 
                data: [ { navTitle: "风之谷", title: "风之谷的娜乌西卡", quote: "“最深的黑暗...”", imageUrl: "https://placehold.co/700x400/7abcff/333?text=风之谷图", description: "经典之作。" }, { navTitle: "天空之城", title: "天空之城拉普达", quote: "“我们的梦想...”", imageUrl: "https://placehold.co/700x400/81c784/333?text=天空图", description: "充满冒险。" }, { navTitle: "龙猫", title: "龙猫多多洛", quote: "“在我们乡下...”", imageUrl: "https://placehold.co/700x400/ffb74d/333?text=龙猫图", description: "温馨治愈。" }, { navTitle: "千与千寻", title: "千与千寻的神隐", quote: "“人生就是一列...”", imageUrl: "https://placehold.co/700x400/e57373/333?text=千寻图", description: "奇妙经历。" }],
                navContainerElement: document.getElementById('drawerNavList'), 
                contentAreaElement: document.getElementById('drawerContentArea'), 
                currentIndex: 0,
            };
            const parallaxInitialConfig = { 
                itemsData: [ 
                    { title: "「四月是你的谎言」", desc: "我在盛开的樱花下遇见你，从此命运不再属于自己。", imageUrl: "https://placehold.co/1920x800/a2d2ff/333333?text=视差1" },
                    { title: "「言叶之庭」", desc: "每晚临睡前 每天睁开眼的瞬间 不知不觉 我都在祈盼雨天", imageUrl: "https://placehold.co/1920x800/bde0fe/333333?text=视差2" },
                    { title: "「你的名字」", desc: "黄昏，不是白昼亦不是夜晚，是我努力却看不清你的脸。", imageUrl: "https://placehold.co/1920x800/ffafcc/333333?text=视差3" },
                    { title: "「天气之子」", desc: "天气真的是很不可思议，光只是天空的模样就让人感动不已。", imageUrl: "https://placehold.co/1920x800/ffc8dd/333333?text=视差4" }
                ],
                containerElement: document.getElementById('parallaxSection'),
                itemContainerElement: document.getElementById('parallaxItemContainer')
            };


            let hasEntered = false;
            function handleInitialScroll(event) {
                if (hasEntered) return;
                if (event.deltaY > 0) { 
                    hasEntered = true;
                    if(entryPage) entryPage.classList.add('hidden');
                    if(mainContentContainer) mainContentContainer.classList.add('visible');
                    if(musicPlayerContainer) musicPlayerContainer.classList.add('visible');
                    switchToView(currentView); 
                    playCurrentSong();
                    window.removeEventListener('wheel', handleInitialScroll); 
                }
            }
            window.addEventListener('wheel', handleInitialScroll, { passive: true }); 


            if (musicPlayerContainer && backgroundMusic && playPauseButton && songTitleElement && progressBarContainer && progressBar && nextSongButton && prevSongButton && currentTimeDisplay && totalDurationDisplay) {
                 loadSong(currentSongIndex); 
                playPauseButton.addEventListener('click', () => {
                    if (backgroundMusic.paused || backgroundMusic.ended) playCurrentSong();
                    else backgroundMusic.pause();
                });
                nextSongButton.addEventListener('click', () => {
                    currentSongIndex = (currentSongIndex + 1) % localMusicFiles.length;
                    loadSong(currentSongIndex); playCurrentSong();
                });
                prevSongButton.addEventListener('click', () => {
                    currentSongIndex = (currentSongIndex - 1 + localMusicFiles.length) % localMusicFiles.length;
                    loadSong(currentSongIndex); playCurrentSong();
                });
                backgroundMusic.addEventListener('play', () => playPauseButton.innerHTML = '<i class="fas fa-pause"></i>');
                backgroundMusic.addEventListener('pause', () => playPauseButton.innerHTML = '<i class="fas fa-play"></i>');
                backgroundMusic.addEventListener('ended', () => nextSongButton.click());
                backgroundMusic.addEventListener('loadedmetadata', () => totalDurationDisplay.textContent = formatTime(backgroundMusic.duration));
                backgroundMusic.addEventListener('timeupdate', () => {
                    if (backgroundMusic.duration) {
                        progressBar.style.width = `${(backgroundMusic.currentTime / backgroundMusic.duration) * 100}%`;
                        currentTimeDisplay.textContent = formatTime(backgroundMusic.currentTime);
                    } else {
                        progressBar.style.width = `0%`; currentTimeDisplay.textContent = "0:00";
                    }
                });
                progressBarContainer.addEventListener('click', (e) => {
                    if (backgroundMusic.duration) {
                        const r = progressBarContainer.getBoundingClientRect();
                        backgroundMusic.currentTime = backgroundMusic.duration * ((e.clientX - r.left) / r.width);
                    }
                });
            } else { console.error("音乐播放器的某些元素未找到!"); }
            
            if (musicPlayerContainer) {
                let isDragging = false, dOX, dOY;
                musicPlayerContainer.addEventListener('mousedown', (e) => {
                    if (e.target.closest('button') || e.target.closest('.progress-bar-container')) return;
                    isDragging = true; dOX = e.clientX - musicPlayerContainer.getBoundingClientRect().left;
                    dOY = e.clientY - musicPlayerContainer.getBoundingClientRect().top;
                    musicPlayerContainer.style.cursor = 'grabbing';
                });
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return; e.preventDefault(); 
                    let nL = e.clientX - dOX, nT = e.clientY - dOY;
                    const bW = document.documentElement.clientWidth, bH = document.documentElement.clientHeight;
                    const pW = musicPlayerContainer.offsetWidth, pH = musicPlayerContainer.offsetHeight;
                    nL = Math.max(0, Math.min(nL, bW - pW)); nT = Math.max(0, Math.min(nT, bH - pH));
                    musicPlayerContainer.style.left = nL + 'px'; musicPlayerContainer.style.top = nT + 'px';
                    musicPlayerContainer.style.right = 'auto'; musicPlayerContainer.style.bottom = 'auto';
                });
                document.addEventListener('mouseup', () => {
                    if (isDragging) { isDragging = false; musicPlayerContainer.style.cursor = 'grab';}
                });
            }


            function switchToView(viewName) {
                currentView = viewName;
                if (!carouselSection || !accordionSection || !drawerCarouselSection || !parallaxSection) { return; }
                
                carouselSection.classList.remove('active-view');
                accordionSection.classList.remove('active-view');
                drawerCarouselSection.classList.remove('active-view'); 
                parallaxSection.classList.remove('active-view');

                if (viewName === 'carousel') carouselSection.classList.add('active-view');
                else if (viewName === 'accordion') accordionSection.classList.add('active-view');
                else if (viewName === 'drawerCarousel') drawerCarouselSection.classList.add('active-view');
                else if (viewName === 'parallax') parallaxSection.classList.add('active-view');
            }

            // 初始化所有模块
            if (typeof CarouselModule !== 'undefined' && CarouselModule.init &&
                typeof AccordionModule !== 'undefined' && AccordionModule.init &&
                typeof DrawerCarouselModule !== 'undefined' && DrawerCarouselModule.init &&
                typeof ParallaxModule !== 'undefined' && ParallaxModule.init) {
                
                CarouselModule.init(carouselInitialConfig, () => switchToView('accordion'));
                
                AccordionModule.init(
                    accordionInitialConfig, 
                    () => switchToView('drawerCarousel'), 
                    () => switchToView('carousel')       
                );
                
                DrawerCarouselModule.init(
                    drawerCarouselInitialConfig, 
                    () => switchToView('accordion'), 
                    () => switchToView('parallax')   
                );

                ParallaxModule.init(
                    parallaxInitialConfig,
                    () => switchToView('drawerCarousel'), 
                    () => switchToView('carousel')        
                );

            } else {
                console.error("一个或多个模块未定义或缺少 init 方法。");
            }

            // 全局滚轮事件监听
            window.addEventListener('wheel', (event) => {
                if (!mainContentContainer.classList.contains('visible') || globalIsThrottled || hasEntered === false) return; 
                
                let viewSwitchedByModule = false;
                
                if (currentView === 'carousel' && CarouselModule.handleWheel) {
                    viewSwitchedByModule = CarouselModule.handleWheel(event);
                } else if (currentView === 'accordion' && AccordionModule.handleWheel) {
                    viewSwitchedByModule = AccordionModule.handleWheel(event);
                } else if (currentView === 'drawerCarousel' && DrawerCarouselModule.handleWheel) {
                    viewSwitchedByModule = DrawerCarouselModule.handleWheel(event);
                } else if (currentView === 'parallax' && ParallaxModule.handleWheel) {
                    viewSwitchedByModule = ParallaxModule.handleWheel(event);
                }
                
                if (viewSwitchedByModule) { 
                    event.preventDefault(); // Only prevent default if a module handled a view switch or internal navigation
                    globalIsThrottled = true;
                    setTimeout(() => { globalIsThrottled = false; }, globalThrottleDelay);
                } else if (currentView === 'parallax') { // If parallax and no view switch, allow default scroll
                    globalIsThrottled = false; 
                }
                // For other views, if handleWheel didn't return true (e.g., at boundary but no callback),
                // we still might want to prevent default and throttle to avoid page scroll.
                // The current module design implies handleWheel returns true if it "consumed" the event.
                // If it returns false (or nothing), and it's not parallax, it might mean it's at a boundary
                // but has no callback to switch view. In this case, we should still prevent default.
                // The logic: if a module *explicitly* returns true, we know it handled it (either nav or switch).
                // If it's parallax and returns false, it's internal scroll.
                // If it's *not* parallax and returns false/undefined, it might be at a boundary with no callback.
                // The current `handleWheel` for non-parallax modules *always* returns true if they are active.
                // So, this 'else if' should correctly handle the parallax internal scroll case.

            }, { passive: false }); 
        });
    </script>
</body>
</html>
